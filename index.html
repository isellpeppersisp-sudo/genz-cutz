<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lets Book</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    /* --- 1. THEME & GENERAL STYLING --- */
    :root {
      --background-primary: #0D1117;
      --background-secondary: #161B22;
      --background-panel: #010409;
      --background-card: #161B22;
      --accent-primary: #30C59B;
      --accent-glow: rgba(48, 197, 155, 0.2);
      --text-primary: #E6EDF3;
      --text-secondary: #8B949E;
      --border-color: rgba(48, 197, 155, 0.25);
      --success-color: #238636;
      --error-color: #F85149;
      --shadow-color: rgba(0, 0, 0, 0.7);
      --font-family: 'Poppins', sans-serif;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes animatedGradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    @keyframes pulseGlow {
        0% { text-shadow: 0 0 5px var(--accent-glow); }
        50% { text-shadow: 0 0 10px var(--accent-glow), 0 0 15px var(--accent-glow); }
        100% { text-shadow: 0 0 5px var(--accent-glow); }
    }
    body {
      font-family: var(--font-family);
      color: var(--text-primary);
      background: linear-gradient(-45deg, #0D1117, #1E2A3B, #0D1117, #1D2633);
      background-size: 400% 400%;
      animation: animatedGradient 15s ease infinite;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .hidden { display:none !important; }

    /* --- LOADER --- */
    .loader {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 8px solid var(--background-secondary);
      border-top-color: var(--accent-primary);
      animation: spin 1s linear infinite;
      margin: 5rem auto; /* Centers the loader */
    }

    /* --- 2. LAYOUT --- */
    .booking-dashboard { display:grid; grid-template-columns: 380px 1fr; min-height:100vh; }
    .summary-panel {
      background-color: var(--background-panel); padding:2.5rem; position:sticky; top:0; height:100vh;
      border-right:1px solid var(--border-color); display:flex; flex-direction:column;
    }
    #header-image { width:120px; height:120px; border-radius:50%; object-fit:cover; border:2px solid var(--border-color); margin:0 auto 1rem; display:none; }
    
    .main-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--accent-primary);
        text-shadow: 0 0 5px var(--accent-glow);
        animation: pulseGlow 3s ease-in-out infinite;
    }
    
    .shop-name-desktop {
        text-align: center;
        margin-bottom: 2.5rem;
    }
    .shop-name-mobile {
        text-align: center;
        margin-bottom: 2rem;
        display: none;
    }

    .summary-item { margin-bottom:2rem; border-left:3px solid var(--border-color); padding-left:1rem; }
    .summary-item h4 { margin-bottom:0.4rem; color:var(--text-secondary); }
    .summary-item p.placeholder { color:#666; }
    .summary-item.active p { color: var(--text-primary); }
    .steps-panel { padding:3rem; }

    /* --- 3. STEP HEADERS & NAVIGATION --- */
    .step-header {
        margin-bottom: 2rem;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1.5rem;
    }
    .step-header h3 {
        font-size: 2rem;
        margin: 0;
        flex-grow: 1;
    }
    .step-header p {
        width: 100%;
        margin: 0;
        color: var(--text-secondary);
    }
    .btn-back {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.7rem 1.4rem;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        line-height: 1;
    }
    .btn-back:hover {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
        color: var(--background-panel);
        box-shadow: 0 0 15px var(--accent-glow);
        transform: translateY(-2px);
    }


    /* --- 4. CARDS & INPUTS --- */
    .category-tabs { display:flex; justify-content:center; flex-wrap:wrap; margin-bottom:2rem; gap:1rem; }
    .category-tab { padding:0.75rem 1.5rem; border-radius:25px; border:1px solid var(--border-color); background:var(--background-secondary); color:var(--text-secondary); font-weight:600; cursor:pointer; transition:all .3s; }
    .category-tab:hover, .category-tab.active { background:var(--accent-primary); border-color:var(--accent-primary); color:#010409; box-shadow:0 0 20px var(--accent-glow); }
    .card-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap:2rem; }
    .selectable-card { background:var(--background-card); border-radius:16px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,.3); transition: transform .3s, box-shadow .3s, border-color .3s; border:2px solid var(--background-card); cursor:pointer; display:flex; flex-direction:column; }
    .selectable-card:hover { transform: translateY(-8px); box-shadow:0 0 25px var(--accent-glow); border-color:var(--accent-primary); }
    
    .card-image {
      width: 100%;
      height: 180px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--background-secondary); 
      background-size: contain; 
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .card-content { padding:1.5rem; display:flex; flex-direction:column; flex-grow:1; }
    .card-content h3 { font-size:1.3rem; }
    .card-content p { font-size:.9rem; color:var(--text-secondary); line-height:1.5; margin-top:.5rem; flex-grow:1; }
    .service-details { display:flex; justify-content:space-between; align-items:center; margin-top:1.5rem; font-weight:600; }
    .service-details .price { font-size:1.3rem; color:var(--accent-primary); }

    .barber-card .card-content {
        justify-content: center;
        text-align: center;
        min-height: 80px;
    }

    /* Time Slot UI */
    .date-selector { display:flex; justify-content:space-between; align-items:center; background:var(--background-secondary); padding:.75rem; border-radius:8px; margin-bottom:2rem; }
    #current-date { font-size:1.2rem; font-weight:600; }
    .date-nav { padding:.6rem 1.2rem; background:transparent; border:1px solid var(--accent-primary); color:var(--accent-primary); border-radius:6px; cursor:pointer; font-weight:700; transition:all .3s; }
    .date-nav:hover:not(:disabled) { background:var(--accent-primary); color:var(--background-panel); box-shadow:0 0 15px var(--accent-glow); }
    .date-nav:disabled { border-color:#444; color:var(--text-secondary); cursor:not-allowed; }

    #time-slots { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:1rem; }
    .time-slot { padding:1rem; border:1px solid var(--border-color); color:var(--text-primary); text-align:center; cursor:pointer; border-radius:6px; font-weight:600; transition:all .2s; background: rgba(48,197,155,.15); }
    .time-slot:hover:not(:disabled) { background:var(--accent-primary); color:var(--background-panel); transform:scale(1.05); box-shadow:0 0 15px var(--accent-glow); }
    .time-slot:disabled { border-color:#333; color:#555; background:transparent; cursor:not-allowed; }

    /* Form */
    #customer-form .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
    .form-group label { display:block; margin-bottom:.5rem; color:var(--text-secondary); }
    .form-group input { width:100%; padding:1rem; background:var(--background-secondary); border:1px solid var(--border-color); color:var(--text-primary); border-radius:8px; font-size:1rem; transition:all .3s; }
    .form-group input:focus { outline:none; border-color:var(--accent-primary); box-shadow:0 0 10px var(--accent-glow); }
    .btn-submit { width:100%; padding:1rem; background:var(--success-color); color:#fff; border:none; border-radius:8px; font-size:1.1rem; font-weight:700; cursor:pointer; transition:all .3s; margin-top:2rem; }
    .btn-submit:hover:not(:disabled) { background:#2D9C42; transform:translateY(-2px); box-shadow:0 0 15px rgba(35,134,54,.4); }

    /* Confirmation & Error */
    #confirmation-step { text-align:center; }
    #confirmation-step h3 { font-size:2.5rem; color: var(--success-color); }
    .error-message { color:var(--error-color); background:rgba(248,81,73,.1); border:1px solid rgba(248,81,73,.3); text-align:center; padding:1rem; border-radius:8px; margin-top:1rem; }
    .calendar-links { margin-top:2.5rem; display:flex; justify-content:center; gap:1rem; }
    .calendar-links a { padding:.8rem 1.5rem; text-decoration:none; border-radius:8px; font-weight:600; color:#fff; transition:all .3s; }
    .calendar-links a:hover { transform: translateY(-2px); opacity:.9; }
    .calendar-links a.google { background:#4285F4; }
    .calendar-links a.outlook { background:#0072C6; }

    /* --- 5. Responsive --- */
    @media (max-width:1200px) {
      .booking-dashboard { grid-template-columns:1fr; }
      .summary-panel { position:relative; height:auto; border-right:none; border-bottom:1px solid var(--border-color); }
      .steps-panel { padding:2.5rem 2rem; }
    }
    @media (max-width:768px) {
      .steps-panel { padding:2rem 1rem; }
      .btn-back { position:static; margin-bottom:1.5rem; display:inline-block; }
      #customer-form .form-grid { grid-template-columns:1fr; }
      .summary-panel {
        display: none;
      }
      .shop-name-desktop {
          display: none;
      }
      .shop-name-mobile {
          display: block;
      }
    }
  </style>
</head>
<body>
<div class="booking-dashboard">
  <aside class="summary-panel">
    <img id="header-image" src="" alt="Barber Shop Logo"/>
    <h2 id="shop-name-title" class="shop-name-desktop main-title">Your Appointment</h2>
    <div id="summary-service-item" class="summary-item"><h4>Service</h4><p id="summary-service" class="placeholder">Select a service</p></div>
    <div id="summary-barber-item" class="summary-item"><h4>Barber</h4><p id="summary-barber" class="placeholder">Select a barber</p></div>
    <div id="summary-datetime-item" class="summary-item"><h4>Date & Time</h4><p id="summary-datetime" class="placeholder">Choose a time slot</p></div>
    <div id="summary-price-item" class="summary-item"><h4>Price</h4><p id="summary-price">$0.00</p></div>
    <div id="error-container" class="error-message hidden"></div>
  </aside>

  <main class="steps-panel">
    <h2 class="shop-name-mobile main-title">The Modern Cut</h2>
    <div id="loader" class="loader"></div>

    <section id="services-step" class="booking-step hidden">
      <div class="step-header">
        <h3>Choose a Service</h3>
        <p>Select from our range of professional services.</p>
      </div>
      <div id="category-tabs" class="category-tabs"></div>
      <div id="service-list" class="card-grid"></div>
    </section>

    <section id="barbers-step" class="booking-step hidden">
      <div class="step-header">
          <button class="btn-back">← Go Back</button>
          <h3>Select Your Barber</h3>
          <p>Choose your preferred professional.</p>
      </div>
      <div id="barber-list" class="card-grid"></div>
    </section>

    <section id="time-step" class="booking-step hidden">
      <div class="step-header">
          <button class="btn-back">← Go Back</button>
          <h3>Pick a Date & Time</h3>
          <p>Find a time slot that works for you.</p>
      </div>
      <div class="date-selector">
        <button id="prev-day" class="date-nav">&lt; Prev</button>
        <span id="current-date"></span>
        <button id="next-day" class="date-nav">Next &gt;</button>
      </div>
      <div id="time-slots"></div>
      <p id="time-slot-message" class="error-message hidden"></p>
    </section>

    <section id="details-step" class="booking-step hidden">
      <div class="step-header">
          <button class="btn-back">← Go Back</button>
          <h3>Confirm Your Details</h3>
          <p>Almost there! Please fill out your information below.</p>
      </div>
      <form id="customer-form">
        <div class="form-grid">
          <div class="form-group"><label for="customer-name">Full Name</label><input type="text" id="customer-name" required></div>
          <div class="form-group"><label for="customer-email">Email</label><input type="email" id="customer-email" required></div>
          <div class="form-group"><label for="customer-contact">Contact Number</label><input type="tel" id="customer-contact" required></div>
        </div>
        <button type="submit" id="submit-booking" class="btn-submit">Book Appointment</button>
      </form>
    </section>

    <section id="confirmation-step" class="booking-step hidden">
      <h3>Booking Confirmed!</h3>
      <p>An email confirmation has been sent to you. We look forward to seeing you!</p>
      <div id="add-to-calendar-links" class="calendar-links"></div>
    </section>
  </main>
</div>

<script>
  const config = {
    shopName: "The Modern Cut",
    // URLs for our two Netlify functions
    getDataURL: "/.netlify/functions/getBookingData",
    submitDataURL: "/.netlify/functions/submitBooking"
	};

  document.addEventListener('DOMContentLoaded', () => {
    let appData = {};
    let bookingState = { selectedDate: new Date(), selectedService: null, selectedBarber: null, selectedTime: null, history: [] };

    const DOMElements = {
      loader: document.getElementById('loader'),
      errorContainer: document.getElementById('error-container'),
      headerImage: document.getElementById('header-image'),
      shopNameDesktop: document.getElementById('shop-name-title'),
      shopNameMobile: document.querySelector('.shop-name-mobile'),
      summary: {
        serviceItem: document.getElementById('summary-service-item'),
        service: document.getElementById('summary-service'),
        barberItem: document.getElementById('summary-barber-item'),
        barber: document.getElementById('summary-barber'),
        datetimeItem: document.getElementById('summary-datetime-item'),
        datetime: document.getElementById('summary-datetime'),
        price: document.getElementById('summary-price')
      },
      steps: {
        services: document.getElementById('services-step'),
        barbers: document.getElementById('barbers-step'),
        time: document.getElementById('time-step'),
        details: document.getElementById('details-step'),
        confirmation: document.getElementById('confirmation-step')
      },
      categoryTabs: document.getElementById('category-tabs'),
      serviceList: document.getElementById('service-list'),
      barberList: document.getElementById('barber-list'),
      prevDayBtn: document.getElementById('prev-day'),
      nextDayBtn: document.getElementById('next-day'),
      currentDateEl: document.getElementById('current-date'),
      timeSlots: document.getElementById('time-slots'),
      timeSlotMessage: document.getElementById('time-slot-message'),
      customerForm: document.getElementById('customer-form'),
      submitBookingBtn: document.getElementById('submit-booking'),
      calendarLinks: document.getElementById('add-to-calendar-links'),
      backButtons: document.querySelectorAll('.btn-back')
    };

    const showError = (message) => {
      DOMElements.loader.classList.add('hidden');
      DOMElements.errorContainer.textContent = message;
      DOMElements.errorContainer.classList.remove('hidden');
    };

    const showStep = (stepToShow) => {
      Object.values(DOMElements.steps).forEach(step => step.classList.add('hidden'));
      if (stepToShow) {
        stepToShow.classList.remove('hidden');
        if (window.innerWidth > 1200) stepToShow.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };

    const goBack = () => {
      if (bookingState.history.length === 0) return;
      const currentStep = Object.values(DOMElements.steps).find(step => !step.classList.contains('hidden'));

      if (currentStep === DOMElements.steps.barbers) {
        bookingState = { ...bookingState, selectedService: null, selectedBarber: null, selectedTime: null };
      } else if (currentStep === DOMElements.steps.time) {
        bookingState = { ...bookingState, selectedBarber: null, selectedTime: null };
      } else if (currentStep === DOMElements.steps.details) {
        bookingState.selectedTime = null;
      }

      updateSummary();
      const previousStep = bookingState.history.pop();
      showStep(previousStep);
    };

    const updateSummary = () => {
      const { service, barber, datetime, price, serviceItem, barberItem, datetimeItem } = DOMElements.summary;
      service.textContent = 'Select a service'; service.classList.add('placeholder'); serviceItem.classList.remove('active');
      barber.textContent = 'Select a barber'; barber.classList.add('placeholder'); barberItem.classList.remove('active');
      datetime.textContent = 'Choose a time slot'; datetime.classList.add('placeholder'); datetimeItem.classList.remove('active');
      price.textContent = '$0.00';

      if (bookingState.selectedService) {
        service.textContent = bookingState.selectedService.Name; service.classList.remove('placeholder'); serviceItem.classList.add('active');
        price.textContent = `$${Number(bookingState.selectedService.Price).toFixed(2)}`;
        barberItem.classList.add('active');
      }
      if (bookingState.selectedBarber) {
        barber.textContent = bookingState.selectedBarber; barber.classList.remove('placeholder');
        datetimeItem.classList.add('active');
      }
      if (bookingState.selectedTime) {
        const dateStr = bookingState.selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
        const timeStr = bookingState.selectedTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        datetime.textContent = `${dateStr} at ${timeStr}`; datetime.classList.remove('placeholder');
      }
    };

    const handleServiceClick = (service) => {
      bookingState.history.push(DOMElements.steps.services);
      bookingState.selectedService = service;
      updateSummary();
      const availableBarbers = service.BarberName;
      if (Array.isArray(availableBarbers) && availableBarbers.length === 1) {
        handleBarberClick(availableBarbers[0]);
      } else if (Array.isArray(availableBarbers) && availableBarbers.length > 1) {
        renderBarbers(availableBarbers);
        showStep(DOMElements.steps.barbers);
      } else {
        showError("This service has no barbers assigned.");
      }
    };

    const handleBarberClick = (barberName) => {
      bookingState.history.push(DOMElements.steps.barbers);
      bookingState.selectedBarber = barberName;
      updateSummary();
      updateDateDisplay();
      showStep(DOMElements.steps.time);
    };

    const handleTimeSlotClick = (time) => {
      bookingState.history.push(DOMElements.steps.time);
      bookingState.selectedTime = time;
      updateSummary();
      showStep(DOMElements.steps.details);
    };

    const renderServices = (category, categories) => {
      document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.category-tab[data-category="${category}"]`).classList.add('active');
      DOMElements.serviceList.innerHTML = categories[category].map(service => `
        <div class="selectable-card service-card">
          ${service.ImageURL ? `<div class="card-image" style="background-image: url('${service.ImageURL}')"></div>` : ''}
          <div class="card-content">
            <h3>${service.Name}</h3>
            <p>${service.Description || ' '}</p>
            <div class="service-details">
              <span>${service.Duration} min</span>
              <span class="price">$${Number(service.Price).toFixed(2)}</span>
            </div>
          </div>
        </div>`).join('');
      document.querySelectorAll('.service-card').forEach((card, i) =>
        card.addEventListener('click', () => handleServiceClick(categories[category][i]))
      );
    };

    const renderBarbers = (barbers) => {
      DOMElements.barberList.innerHTML = barbers.map(barber => `
        <div class="selectable-card barber-card">
          <div class="card-content"><h3>${barber}</h3></div>
        </div>`).join('');
      document.querySelectorAll('.barber-card').forEach((card, i) =>
        card.addEventListener('click', () => handleBarberClick(barbers[i]))
      );
    };

    const updateDateDisplay = () => {
      DOMElements.currentDateEl.textContent =
        bookingState.selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

      const today = new Date(); today.setHours(0,0,0,0);
      const selectedMidnight = new Date(bookingState.selectedDate); selectedMidnight.setHours(0,0,0,0);
      DOMElements.prevDayBtn.disabled = (selectedMidnight <= today);

      generateTimeSlots();
    };

    const generateTimeSlots = () => {
      DOMElements.timeSlots.innerHTML = '';
      DOMElements.timeSlotMessage.classList.add('hidden');
      if (!bookingState.selectedService || !bookingState.selectedBarber) return;

      const dayOfWeek = bookingState.selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
      const hours = appData.openingHours.find(h =>
        h.Day === dayOfWeek &&
        Array.isArray(h.BarberName) &&
        h.BarberName.includes(bookingState.selectedBarber)
      );

      if (!hours || hours.IsClosed) {
        DOMElements.timeSlotMessage.textContent = `Sorry, ${bookingState.selectedBarber} is unavailable on this day.`;
        DOMElements.timeSlotMessage.classList.remove('hidden');
        return;
      }

      const d = bookingState.selectedDate;
      const selectedDay = d.getDate(), selectedMonth = d.getMonth(), selectedYear = d.getFullYear();
      const bookingsForDay = appData.bookings.filter(b => {
        if (b.BarberName !== bookingState.selectedBarber) return false;
        const bookingDate = new Date(b.StartTime);
        return bookingDate.getDate() === selectedDay &&
               bookingDate.getMonth() === selectedMonth &&
               bookingDate.getFullYear() === selectedYear;
      });

      const { Duration } = bookingState.selectedService;
      const bufferTime = parseInt(appData.settings.bufferTime) || 0;

      const dayStart = new Date(bookingState.selectedDate);
      const [startHour, startMinute] = String(hours.StartTime).split(':');
      dayStart.setHours(parseInt(startHour,10), parseInt(startMinute,10), 0, 0);

      const dayEnd = new Date(bookingState.selectedDate);
      const [endHour, endMinute] = String(hours.EndTime).split(':');
      dayEnd.setHours(parseInt(endHour,10), parseInt(endMinute,10), 0, 0);

      let availableSlots = 0;
      let currentTime = new Date(dayStart);

      while (currentTime < dayEnd) {
        const slotStartTime = new Date(currentTime);
        const slotEndTime = new Date(slotStartTime.getTime() + (parseInt(Duration,10) || 0) * 60000);
        if (slotEndTime > dayEnd) break;

        const isPast = new Date() > slotStartTime;
        
        if (!isPast) {
            const isOverlapping = bookingsForDay.some(b => {
                const existingStart = new Date(b.StartTime);
                const existingEnd = new Date(b.EndTime);
                const bookingEndWithBuffer = new Date(existingEnd.getTime() + bufferTime * 60000);
                return slotStartTime < bookingEndWithBuffer && slotEndTime > existingStart;
            });
    
            const slotButton = document.createElement('button');
            slotButton.className = 'time-slot';
    
            if (isOverlapping) {
                slotButton.disabled = true;
                slotButton.textContent = 'Booked';
                DOMElements.timeSlots.appendChild(slotButton);
            } else {
                availableSlots++;
                slotButton.textContent = slotStartTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                slotButton.addEventListener('click', () => handleTimeSlotClick(slotStartTime));
                DOMElements.timeSlots.appendChild(slotButton);
            }
        }

        currentTime.setMinutes(currentTime.getMinutes() + 15);
      }

      if (availableSlots === 0) {
        DOMElements.timeSlotMessage.textContent = 'No available slots for this day.';
        DOMElements.timeSlotMessage.classList.remove('hidden');
      }
    };

    const init = async () => {
      DOMElements.shopNameDesktop.textContent = config.shopName;
      if (DOMElements.shopNameMobile) {
          DOMElements.shopNameMobile.textContent = config.shopName;
      }
      
      try {
        const response = await fetch(config.getDataURL);
        if (!response.ok) throw new Error(`Network response was not ok`);
        appData = await response.json();
        if (appData.error) throw new Error(appData.error);

        if (appData.settings?.backgroundimageurl) {
          DOMElements.headerImage.src = appData.settings.backgroundimageurl;
          DOMElements.headerImage.style.display = 'block';
        }

        appData.bookings = (appData.bookings || []).map(b => ({
          ...b,
          StartTime: new Date(b.StartTime),
          EndTime: new Date(b.EndTime)
        }));

        DOMElements.loader.classList.add('hidden');

        const categories = (appData.services || []).reduce((acc, service) => {
          const category = service.Category || 'General';
          if (!acc[category]) acc[category] = [];
          acc[category].push(service);
          return acc;
        }, {});

        DOMElements.categoryTabs.innerHTML = Object.keys(categories).map(cat =>
          `<div class="category-tab" data-category="${cat}">${cat}</div>`
        ).join('');

        document.querySelectorAll('.category-tab').forEach(tab => {
          tab.addEventListener('click', () => renderServices(tab.dataset.category, categories));
        });

        if (Object.keys(categories).length > 0) {
          renderServices(Object.keys(categories)[0], categories);
        }
        showStep(DOMElements.steps.services);

      } catch (error) {
        showError(`Failed to load booking data. Check setup. Details: ${error.message}`);
      }
    };

    DOMElements.backButtons.forEach(button => button.addEventListener('click', goBack));
    DOMElements.prevDayBtn.addEventListener('click', () => { bookingState.selectedDate.setDate(bookingState.selectedDate.getDate() - 1); updateDateDisplay(); });
    DOMElements.nextDayBtn.addEventListener('click', () => { bookingState.selectedDate.setDate(bookingState.selectedDate.getDate() + 1); updateDateDisplay(); });

    DOMElements.customerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      DOMElements.submitBookingBtn.disabled = true;
      DOMElements.submitBookingBtn.textContent = 'Booking...';

      const { selectedTime, selectedService, selectedBarber } = bookingState;
      const bookingDetails = {
        customerName: document.getElementById('customer-name').value,
        customerEmail: document.getElementById('customer-email').value,
        customerContact: document.getElementById('customer-contact').value,
        serviceName: selectedService.Name,
        barberName: selectedBarber,
        startTime: selectedTime.toISOString(),
        endTime: new Date(selectedTime.getTime() + selectedService.Duration * 60000).toISOString(),
      };

      try {
        const response = await fetch(config.submitDataURL, { method: 'POST', body: JSON.stringify(bookingDetails) });
        if (!response.ok) throw new Error(`Server error: ${response.statusText}`);

        const result = await response.json();
        if (result.status !== "success") {
          throw new Error(result.message || 'An unknown booking error occurred.');
        }

        showStep(DOMElements.steps.confirmation);

        const { serviceName, barberName, startTime, endTime } = bookingDetails;
        const title = encodeURIComponent(`Appointment: ${serviceName} with ${barberName}`);
        const startISO = new Date(startTime).toISOString().replace(/[-:.]/g, '');
        const endISO = new Date(endTime).toISOString().replace(/[-:.]/g, '');
        DOMElements.calendarLinks.innerHTML = `
          <a href="https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startISO}/${endISO}" target="_blank" class="google">Add to Google Calendar</a>
          <a href="https://outlook.live.com/calendar/0/deeplink/compose?path=/calendar/action/compose&rru=addevent&subject=${title}&startdt=${startTime}&enddt=${endTime}" target="_blank" class="outlook">Add to Outlook Calendar</a>`;

      } catch (error) {
        alert(`Booking Failed: ${error.message}`);
        DOMElements.submitBookingBtn.disabled = false;
        DOMElements.submitBookingBtn.textContent = 'Book Appointment';
        showError("Please wait, refreshing schedule.");
        init();
      }
    });

    init();
  });
</script>
</body>
</html>